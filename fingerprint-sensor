#include <Adafruit_Fingerprint.h>
#include<ModbusRtu.h>      
Modbus bus;
unsigned long timer1;
bool attachedFinger = false;
int id;
int outMessage = -1;

// Инициализация Software Serial для датчика отпечатков пальцев
SoftwareSerial mySerial(2, 3); // mySerial(TX, RX)

// Инициализация объекта для датчика отпечатков пальцев
Adafruit_Fingerprint finger = Adafruit_Fingerprint(&mySerial);

// Инициализация массива в который будет записываться номер "id"
int sentById [1] = {0};

void setup()
{
  bus = Modbus(1,Serial,5);
  bus.begin(9600);
  Serial.begin(9600);
  delay(100);
//  Serial.println("\n\nAdafruit finger detect test");

  // set the data rate for the sensor serial port
  finger.begin(57600);
  delay(5);
}

void loop()                     // run over and over again
{
  if (attachedFinger == false){
    outMessage = bus.getOutCnt();
  }
  // Пока палец не тронул сенсор будет выполняться следующий код
  if(!attachedFinger){
    // Получаем id отпечатка
    id = getFingerprintIDez();
    delay(50);            //don't ned to run this at full speed.
    }

  // Если палец тронул сенсор и прошла 1 секунда, переменная attachedFinger = false.
//  Это нужно для 2-ух целей:
//  1) Чтобы отпечаток не считывался более 1-го раза в течении 1-ой секунды
//  2) Чтобы отправка на OPC сервер была более стабильной, т.к. без таймера в случае удержания пальца на датчике, увеличивается время ответа.
  if (attachedFinger == true && millis() - timer1 > 1000){
    attachedFinger = false;
    }


  sentById[0] = id;
  bus.poll(sentById, 1);

  // Эта часть кода отвечает за то чтобы не приходил двойной ответ, чтобы не было такого что сотрудник пришел и тут же ушел
  if (outMessage != bus.getOutCnt() && attachedFinger == true){
    id = -1;
    outMessage = bus.getOutCnt();
    }
}

// returns -1 if failed, otherwise returns ID #
int getFingerprintIDez() {
  uint8_t p = finger.getImage();
  if (p != FINGERPRINT_OK)  return -1;

  // При сканировании пальца обновляется таймер и bool переменная attachedFinger = true
  attachedFinger = true;
  timer1 = millis();
  

  p = finger.image2Tz();
  if (p != FINGERPRINT_OK)  return -1;

  p = finger.fingerFastSearch();
  if (p != FINGERPRINT_OK)  return -1;

  // found a match!
//  Serial.print("Found ID #"); Serial.print(finger.fingerID);
//  Serial.print(" with confidence of "); Serial.println(finger.confidence);
  return finger.fingerID;
}
